name: OrangeFox - Build Neom Project

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Manifest Branch'
        required: true
        default: '12.1'
        type: choice
        options:
          - 12.1
          - 11.0

      DEVICE_TREE:
        description: 'OrangeFox Device Tree'
        required: true
        default: 'https://github.com/Mostafameesr/Mostafameesr-android_device_xiaomi_sweet-TWRP_Neom'

      DEVICE_TREE_BRANCH:
        description: 'OrangeFox Device Tree Branch'
        required: true
        default: 'fox_12.1'

      DEVICE_PATH:
        description: 'Specify your Device Path'
        required: true
        default: 'device/xiaomi/sweet'

      DEVICE_NAME:
        description: 'Specify your Device Codename'
        required: true
        default: 'sweet'

      BUILD_TARGET:
        description: 'Specify your Build Target'
        required: true
        default: 'recovery'
        type: choice
        options:
          - recovery
          - boot
          - vendorboot

jobs:
  build:
    name: Build OFR by ${{ github.actor }}
    runs-on: ubuntu-22.04

    permissions:
      contents: write

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      LC_ALL: C
      ALLOW_MISSING_DEPENDENCIES: true
      FOX_VERSION: "R12.0"
      USE_CCACHE: "1"
      CCACHE_COMPRESS: "1"
      CCACHE_MAXSIZE: "20G"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Clean-up Environment
        uses: rokibhasansagar/slimhub_actions@main

      - name: Maximize Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 30

      - name: Install Build Dependencies
        run: |
          sudo apt update
          sudo apt install -y aria2 libncurses5 ccache
          git clone https://gitlab.com/OrangeFox/misc/scripts.git -b master
          cd scripts
          sudo bash setup/android_build_env.sh
          sudo apt install -y openjdk-17-jdk

      - name: Set-up OrangeFox Sync
        run: |
          mkdir -p "${GITHUB_WORKSPACE}/OrangeFox"
          cd "${GITHUB_WORKSPACE}/OrangeFox"
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"

          git clone https://gitlab.com/OrangeFox/sync.git -b master
          cd sync
          ./orangefox_sync.sh --branch "${{ inputs.MANIFEST_BRANCH }}" --path "${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}"

      - name: Clone Device Tree
        run: |
          FOXDIR="${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}"
          cd "$FOXDIR"

          # مهم جدًا: إنشاء المجلدات الأب قبل git clone
          mkdir -p "$(dirname "${{ inputs.DEVICE_PATH }}")"

          git clone "${{ inputs.DEVICE_TREE }}" -b "${{ inputs.DEVICE_TREE_BRANCH }}" "${{ inputs.DEVICE_PATH }}"
          cd "${{ inputs.DEVICE_PATH }}"
          echo "COMMIT_ID=$(git rev-parse --short HEAD)" >> "$GITHUB_ENV"

      - name: Setup ccache (optional)
        run: |
          ccache -M 20G
          ccache -o compression=true
          ccache -s || true

      - name: Building OrangeFox (Neom Project)
        run: |
          cd "${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}"
          source build/envsetup.sh

          lunch "twrp_${{ inputs.DEVICE_NAME }}-eng"

          # نظافة بناء أقل تدميرًا من make clean (اختياري)
          rm -rf out/target/product/${{ inputs.DEVICE_NAME }}/obj || true

          mka "${{ inputs.BUILD_TARGET }}image" -j"$(nproc)"

      - name: Check Build Output
        run: |
          OUT="${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}"
          cd "$OUT"
          ls -lh OrangeFox*.zip || echo "No ZIP found"
          ls -lh OrangeFox*.img || echo "No IMG found"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ github.workspace }}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.img
            ${{ github.workspace }}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.zip
          name: OrangeFox Neom for ${{ inputs.DEVICE_NAME }} [Branch ${{ inputs.MANIFEST_BRANCH }}]
          tag_name: Neom-${{ inputs.DEVICE_NAME }}-${{ inputs.MANIFEST_BRANCH }}-${{ github.run_number }}
          body: |
            ## OrangeFox Recovery - Neom Project
            - **Device:** ${{ inputs.DEVICE_NAME }} (Redmi Note 10 Pro)
            - **Target:** ${{ inputs.BUILD_TARGET }}image
            - **Branch:** ${{ inputs.MANIFEST_BRANCH }}
            - **Maintainer:** Mostafameesr
            - **Commit:** ${{ env.COMMIT_ID }}
